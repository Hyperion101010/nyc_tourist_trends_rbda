#!/usr/bin/env python3
"""
MTA Dataset Cleaning Mapper (EXHAUSTIVE)
- Uses FULL dictionary of NYC Zip Codes (Derived from your lookup file)
- Fixes CSV structure (Handles quotes/commas)
"""
import sys
import csv
import math
import io
from datetime import datetime
import hashlib

# --- COMPLETE NYC ZIP CODE CENTROIDS ---
# Generated from nyc_zip_data_lookup.csv
NYC_ZIPS = {
    "10001": (40.75069, -73.99714), "10002": (40.71578, -73.98617), "10003": (40.73183, -73.98916),
    "10004": (40.70375, -74.01303), "10005": (40.70613, -74.00877), "10006": (40.70826, -74.01355),
    "10007": (40.71360, -74.00796), "10009": (40.72651, -73.97935), "10010": (40.73907, -73.98254),
    "10011": (40.74199, -74.00062), "10012": (40.72559, -73.99824), "10013": (40.72074, -74.00518),
    "10014": (40.73361, -74.00769), "10016": (40.74551, -73.97818), "10017": (40.75231, -73.97223),
    "10018": (40.75508, -73.99335), "10019": (40.76547, -73.98595), "10020": (40.75837, -73.97938),
    "10021": (40.76985, -73.96025), "10022": (40.75878, -73.96701), "10023": (40.77608, -73.98224),
    "10024": (40.78631, -73.97721), "10025": (40.79848, -73.96803), "10026": (40.80238, -73.95267),
    "10027": (40.81156, -73.95368), "10028": (40.77662, -73.95543), "10029": (40.79169, -73.94415),
    "10030": (40.81844, -73.94331), "10031": (40.82517, -73.95011), "10032": (40.83925, -73.94165),
    "10033": (40.84917, -73.93633), "10034": (40.86650, -73.92131), "10035": (40.79553, -73.92955),
    "10036": (40.75971, -73.99182), "10037": (40.81325, -73.93740), "10038": (40.70938, -74.00233),
    "10039": (40.82672, -73.93729), "10040": (40.85845, -73.92939), "10044": (40.76249, -73.95003),
    "10065": (40.76450, -73.96253), "10069": (40.77519, -73.99041), "10075": (40.77341, -73.95634),
    "10111": (40.75845, -73.97750), "10115": (40.80371, -73.96263), "10119": (40.74971, -73.99184),
    "10128": (40.78164, -73.95022), "10154": (40.75787, -73.97223), "10278": (40.71350, -74.00441),
    "10280": (40.70853, -74.01850), "10301": (40.62933, -74.09312), "10302": (40.63185, -74.13735),
    "10303": (40.63414, -74.16787), "10304": (40.60742, -74.08630), "10305": (40.59825, -74.07325),
    "10306": (40.56957, -74.12078), "10307": (40.51261, -74.23730), "10308": (40.55392, -74.14569),
    "10309": (40.52805, -74.21886), "10310": (40.63390, -74.11674), "10312": (40.54228, -74.17721),
    "10314": (40.60336, -74.16274), "10451": (40.82071, -73.92383), "10452": (40.83733, -73.92167),
    "10453": (40.85098, -73.91136), "10454": (40.80614, -73.91746), "10455": (40.81423, -73.90653),
    "10456": (40.83084, -73.90858), "10457": (40.84687, -73.89868), "10458": (40.86315, -73.88939),
    "10459": (40.82479, -73.89307), "10460": (40.84073, -73.88059), "10461": (40.84725, -73.83988),
    "10462": (40.84021, -73.85698), "10463": (40.88053, -73.90906), "10464": (40.85724, -73.78858),
    "10465": (40.82586, -73.81881), "10466": (40.89136, -73.84705), "10467": (40.87455, -73.87031),
    "10468": (40.86795, -73.89882), "10469": (40.86877, -73.84729), "10470": (40.89691, -73.86835),
    "10471": (40.89758, -73.90098), "10472": (40.82955, -73.87405), "10473": (40.81934, -73.86178),
    "10474": (40.81055, -73.88537), "10475": (40.87411, -73.82987), "11001": (40.72594, -73.71350),
    "11004": (40.74574, -73.71261), "11040": (40.75167, -73.69375), "11101": (40.74665, -73.93962),
    "11102": (40.77196, -73.92556), "11103": (40.76346, -73.91307), "11104": (40.74418, -73.91896),
    "11105": (40.77663, -73.90802), "11106": (40.76162, -73.92985), "11109": (40.74438, -73.95744),
    "11201": (40.69539, -73.99222), "11203": (40.64969, -73.93512), "11204": (40.61902, -73.98773),
    "11205": (40.69382, -73.96507), "11206": (40.70197, -73.94186), "11207": (40.66854, -73.89626),
    "11208": (40.67283, -73.87189), "11209": (40.62228, -74.02706), "11210": (40.62776, -73.94695),
    "11211": (40.71269, -73.95066), "11212": (40.66224, -73.91672), "11213": (40.67135, -73.93649),
    "11214": (40.60144, -73.99723), "11215": (40.66632, -73.98254), "11216": (40.68087, -73.94895),
    "11217": (40.68265, -73.97939), "11218": (40.64335, -73.97637), "11219": (40.63276, -74.00030),
    "11220": (40.64121, -74.01704), "11221": (40.69171, -73.92728), "11222": (40.72658, -73.94723),
    "11223": (40.59795, -73.97230), "11224": (40.57627, -73.99757), "11225": (40.66286, -73.95551),
    "11226": (40.64619, -73.95752), "11228": (40.61725, -74.01323), "11229": (40.60010, -73.94318),
    "11230": (40.62232, -73.96605), "11231": (40.67883, -74.00171), "11232": (40.65597, -74.00216),
    "11233": (40.67697, -73.91979), "11234": (40.61793, -73.92383), "11235": (40.58434, -73.95269),
    "11236": (40.63750, -73.90159), "11237": (40.70327, -73.92008), "11238": (40.67963, -73.96417),
    "11239": (40.64654, -73.87878), "11249": (40.71694, -73.96316), "11354": (40.76860, -73.82914),
    "11355": (40.75053, -73.82255), "11356": (40.78534, -73.84305), "11357": (40.78761, -73.81156),
    "11358": (40.76011, -73.79720), "11360": (40.78363, -73.78426), "11361": (40.76442, -73.77207),
    "11362": (40.76023, -73.74325), "11363": (40.77259, -73.75402), "11364": (40.74558, -73.75895),
    "11365": (40.74026, -73.79153), "11366": (40.72911, -73.79373), "11367": (40.73026, -73.81989),
    "11368": (40.74830, -73.85409), "11369": (40.76292, -73.86591), "11370": (40.76239, -73.89139),
    "11372": (40.75080, -73.88451), "11373": (40.73715, -73.87737), "11374": (40.72620, -73.86235),
    "11375": (40.72179, -73.84606), "11377": (40.74345, -73.90422), "11378": (40.72471, -73.90697),
    "11379": (40.71350, -73.88248), "11385": (40.70054, -73.89270), "11411": (40.69557, -73.73748),
    "11412": (40.69722, -73.76025), "11413": (40.67057, -73.74902), "11414": (40.65825, -73.84489),
    "11415": (40.70636, -73.83059), "11416": (40.68694, -73.85250), "11417": (40.67664, -73.84457),
    "11418": (40.69614, -73.83296), "11419": (40.68812, -73.82606), "11420": (40.67323, -73.81640),
    "11421": (40.69085, -73.86173), "11422": (40.66195, -73.73357), "11423": (40.71638, -73.76722),
    "11426": (40.73646, -73.72591), "11427": (40.72778, -73.75330), "11428": (40.71752, -73.74281),
    "11429": (40.70992, -73.73977), "11430": (40.64835, -73.78839), "11432": (40.71181, -73.79374),
    "11433": (40.70119, -73.79155), "11434": (40.67664, -73.77978), "11435": (40.70014, -73.81057),
    "11436": (40.67499, -73.79639), "11691": (40.60098, -73.76346), "11692": (40.59258, -73.79729),
    "11693": (40.59779, -73.81639), "11694": (40.57863, -73.84969), "11697": (40.55998, -73.91428)
}

def get_nearest_zip(lat, lon):
    nearest = "00000"
    min_dist = float('inf')
    for z, (z_lat, z_lon) in NYC_ZIPS.items():
        # Euclidean distance squared (fastest)
        dist_sq = (lat - z_lat)**2 + (lon - z_lon)**2
        if dist_sq < min_dist:
            min_dist = dist_sq
            nearest = z
    return nearest

def main():
    reader = csv.reader(sys.stdin)
    next(reader, None) # Skip Header

    # String buffer for safe CSV writing
    output = io.StringIO()
    writer = csv.writer(output, quoting=csv.QUOTE_MINIMAL)

    for row in reader:
        if len(row) != 12: continue
        try:
            # Parse Timestamp
            dt = datetime.strptime(row[0].strip(), '%m/%d/%Y %I:%M:%S %p')
            iso_ts = dt.strftime('%Y-%m-%d %H:%M:%S')
            
            # Parse Numerics
            ridership = int(row[7].replace(',', '').strip())
            transfers = int(row[8].replace(',', '').strip())
            lat = float(row[9].strip())
            lon = float(row[10].strip())
            
            # Find Zip (Using Exhaustive List)
            zipcode = get_nearest_zip(lat, lon)
            
            # Create Unique Hash
            row_str = f"{iso_ts}{row[2]}{row[5]}{row[6]}"
            row_hash = hashlib.md5(row_str.encode()).hexdigest()
            
            # Prepare Output
            out = [iso_ts, str(dt.year), str(dt.month), str(dt.day), str(dt.hour), dt.strftime('%A'),
                   row[1].lower(), row[2], row[3], row[4], row[5].lower(), row[6], 
                   str(ridership), str(transfers), str(lat), str(lon), zipcode]
            
            # Write safely
            output.seek(0)
            output.truncate(0)
            writer.writerow(out)
            csv_string = output.getvalue().strip()
            
            print(f"{row_hash}\t{csv_string}")
        except: continue

if __name__ == "__main__": main()
